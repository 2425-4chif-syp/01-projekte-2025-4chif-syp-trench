<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm modern-card">
        <div class="form-header">
          <div class="form-header__titles">
            <h3>CSV-Import / Export</h3>
            <p>Datenpakete importieren und exportieren</p>
          </div>
        </div>

        <div class="card-body">
          <!-- Upload Section -->
          <div class="upload-section mb-4">
            <h4 class="mb-3 d-flex align-items-center">
              <i class="fas fa-upload me-2"></i>
              Datenpaket importieren
              <button 
                type="button"
                class="info-button ms-2" 
                (click)="openInfoModal()"
                title="Informationen zum CSV-Format">
                i
              </button>
            </h4>
            <p class="text-muted mb-3">
              Laden Sie eine ZIP-Datei hoch, die CSV-Dateien enthält. 
              <strong>Wichtig:</strong> Alle vorhandenen Daten werden gelöscht und durch die importierten Daten ersetzt.
            </p>
            
            @if (!isAdminMode()) {
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Nur im Admin-Modus können Daten importiert werden.
              </div>
            }

            <div 
              class="upload-area"
              [class.drag-over]="dragOver"
              [class.disabled]="!isAdminMode() || isUploading"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
              (click)="!isAdminMode() || isUploading ? null : fileInput.click()">
              <input 
                type="file" 
                #fileInput
                id="fileInput"
                class="file-input-hidden" 
                accept=".zip"
                (change)="onFileSelected($event)"
                [disabled]="!isAdminMode() || isUploading">
              
              <div class="upload-icon-container">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p class="upload-text">
                  @if (selectedFile) {
                    {{ selectedFile.name }}
                  } @else {
                    Datei hier ablegen oder klicken zum Auswählen
                  }
                </p>
                <p class="upload-hint">Nur ZIP-Dateien werden unterstützt</p>
              </div>
            </div>

            @if (uploadMessage && !uploadError) {
              <div class="alert alert-success mt-3">
                <i class="fas fa-check-circle me-2"></i>
                {{ uploadMessage }}
              </div>
            }
            
            @if (uploadError) {
              <div class="alert alert-danger mt-3">
                <i class="fas fa-exclamation-circle me-2"></i>
                {{ uploadError }}
              </div>
            }

            <div class="upload-button-container mt-3">
              <button 
                class="btn btn-primary"
                (click)="uploadFile()"
                [disabled]="!selectedFile || !isAdminMode() || isUploading">
                @if (isUploading) {
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Importiere...
                } @else {
                  <i class="fas fa-upload me-2"></i>
                  Datei hochladen
                }
              </button>
            </div>
          </div>

          <hr class="my-4">

          <!-- Download Section -->
          <div class="download-section">
            <h4 class="mb-3">
              <i class="fas fa-download me-2"></i>
              Datenpaket exportieren
            </h4>
            <p class="text-muted mb-3">
              Laden Sie alle Daten als ZIP-Datei herunter, die CSV-Dateien enthält.
            </p>

            <button 
              class="btn btn-success"
              (click)="downloadFile()"
              [disabled]="isDownloading">
              @if (isDownloading) {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Exportiere...
              } @else {
                <i class="fas fa-download me-2"></i>
                Datenpaket herunterladen
              }
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Info Modal -->
@if (showInfoModal) {
  <div class="modal-backdrop" (click)="closeInfoModal()"></div>
  <div class="modal show d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-info-circle me-2"></i>
            CSV-Format Informationen
          </h5>
          <button type="button" class="btn-close" (click)="closeInfoModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="info-section mb-4">
            <h6 class="fw-bold mb-3">Allgemeine Anforderungen</h6>
            <ul class="mb-3">
              <li>Das Datenpaket muss eine <strong>ZIP-Datei</strong> sein</li>
              <li>Die ZIP-Datei muss alle erforderlichen CSV-Dateien enthalten</li>
              <li>CSV-Dateien verwenden <strong>Komma (,) als Trennzeichen</strong></li>
              <li>Die erste Zeile jeder CSV-Datei ist die <strong>Header-Zeile</strong> (wird beim Import übersprungen)</li>
              <li>Alle CSV-Dateien müssen im <strong>UTF-8 Format</strong> sein</li>
            </ul>
          </div>

          <div class="info-section mb-4">
            <h6 class="fw-bold mb-3">Erforderliche CSV-Dateien</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead>
                  <tr>
                    <th>Dateiname</th>
                    <th>Spalten (in Reihenfolge)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><code>spuletyp.csv</code></td>
                    <td>ID, Name, Schenkelzahl, Bandbreite, Schichthöhe, Durchmesser, Toleranzbereich, Notiz</td>
                  </tr>
                  <tr>
                    <td><code>spule.csv</code></td>
                    <td>ID, SpuleTypID, Auftragsnr, AuftragsPosNr, Bemessungsspannung, Bemessungsfrequenz, Einheit, Notiz</td>
                  </tr>
                  <tr>
                    <td><code>sondentyp.csv</code></td>
                    <td>ID, Name, Breite, Höhe, Windungszahl, Alpha, Notiz</td>
                  </tr>
                  <tr>
                    <td><code>sonde.csv</code></td>
                    <td>ID, SondenTypID, Name, Kalibrierungsfaktor</td>
                  </tr>
                  <tr>
                    <td><code>messeinstellung.csv</code></td>
                    <td>ID, SpuleID, SondenTypID, Name, SondenProSchenkel</td>
                  </tr>
                  <tr>
                    <td><code>sondenposition.csv</code></td>
                    <td>ID, SondeID, MesseinstellungID, Schenkel, Position</td>
                  </tr>
                  <tr>
                    <td><code>messung.csv</code></td>
                    <td>ID, MesseinstellungID, Anfangszeitpunkt, Endzeitpunkt, Name, Tauchkernstellung, Pruefspannung, Notiz</td>
                  </tr>
                  <tr>
                    <td><code>messwert.csv</code></td>
                    <td>ID, MessungID, SondenPositionID, Wert, Zeitpunkt</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Wichtig:</strong> Beim Import werden alle vorhandenen Daten gelöscht und durch die importierten Daten ersetzt. 
            Stellen Sie sicher, dass alle erforderlichen Dateien im korrekten Format vorliegen.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeInfoModal()">Schließen</button>
        </div>
      </div>
    </div>
  </div>
}

