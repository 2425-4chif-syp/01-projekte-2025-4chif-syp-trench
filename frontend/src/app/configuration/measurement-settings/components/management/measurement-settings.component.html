<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-xl-10 col-lg-11">
      <ng-container *ngIf="selectedMeasurementSetting; else loadError">
        <div class="card shadow-sm modern-card">
          <div class="form-header">
            <div class="form-header__titles">
              <h3>{{ measurementSettingsService.selectedElementIsNew ? 'Neue Messeinstellung' : 'Messeinstellung bearbeiten' }}</h3>
            </div>
            <span class="form-tag" [ngClass]="measurementSettingsService.selectedElementIsNew ? 'tag-new' : 'tag-edit'">
              {{ measurementSettingsService.selectedElementIsNew ? 'Neu' : 'Bearbeiten' }}
            </span>
          </div>

          <div class="card-intro" *ngIf="!measurementSettingsService.selectedElementIsNew && measurementSettingsService.elements.length > 0">
            <label for="measurementSettingSelect" class="visually-hidden">Messeinstellung auswählen</label>
            <div class="select-shell select-shell--full">
              <select
                class="form-select select-control"
                id="measurementSettingSelect"
                name="measurementSettingSelect"
                [(ngModel)]="selectedSettingId"
                (ngModelChange)="onSettingSelectionChange($event)"
              >
                <option *ngFor="let setting of measurementSettingsService.elements" [value]="setting.id">
                  Messeinstellung #{{ setting.id }} {{ setting.name ? '– ' + setting.name : '' }}
                </option>
              </select>
            </div>
          </div>

          <div class="selection-row">
            <div
              class="selection-card"
              [class.is-empty]="!selectedCoil"
              [class.has-error]="saveError && isFieldInvalid('coilId')"
            >
              <span class="selection-card__eyebrow">Spule</span>
              <h4 class="selection-card__title">
                {{ selectedCoil?.auftragsnummer?.trim() || 'Keine Spule ausgewählt' }}
              </h4>
              <p class="selection-card__subtitle" *ngIf="selectedCoil">
                <span *ngIf="selectedCoil.coiltype?.name">Typ {{ selectedCoil.coiltype?.name }}</span>
                <span *ngIf="selectedCoil.coiltype?.name && selectedCoil.id">·</span>
                <span *ngIf="selectedCoil.id">ID {{ selectedCoil.id }}</span>
              </p>
              <p class="selection-card__empty" *ngIf="!selectedCoil">
                Wählen Sie eine Spule für diese Messeinstellung.
              </p>
              <div class="selection-card__chips" *ngIf="selectedCoil">
                <span class="selection-chip" *ngIf="selectedCoil.coiltype?.schenkel != null">
                  Schenkel: {{ selectedCoil.coiltype?.schenkel }}
                </span>
                <span class="selection-chip" *ngIf="selectedCoil.coiltype?.bandbreite != null">
                  Bandbreite: {{ selectedCoil.coiltype?.bandbreite | number: '1.0-1' }} mm
                </span>
                <span class="selection-chip" *ngIf="selectedCoil.coiltype?.durchmesser != null">
                  Ø {{ selectedCoil.coiltype?.durchmesser | number: '1.0-1' }} mm
                </span>
              </div>
              <p class="selection-card__note" *ngIf="selectedCoil?.notiz?.trim()">
                {{ selectedCoil?.notiz }}
              </p>
              <button type="button" class="selection-card__action" (click)="openCoilSelect()">
                <span>{{ selectedCoil ? 'Spule ändern' : 'Spule wählen' }}</span>
                <span class="selection-card__action-icon" aria-hidden="true">→</span>
              </button>
            </div>

            <div
              class="selection-card"
              [class.is-empty]="!selectedProbeType"
              [class.has-error]="saveError && isFieldInvalid('probeTypeId')"
            >
              <span class="selection-card__eyebrow">Messsondentyp</span>
              <h4 class="selection-card__title">
                {{ selectedProbeType?.name?.trim() || 'Kein Messsondentyp ausgewählt' }}
              </h4>
              <p class="selection-card__subtitle" *ngIf="selectedProbeType">
                ID {{ selectedProbeType.id }}
              </p>
              <p class="selection-card__empty" *ngIf="!selectedProbeType">
                Wählen Sie einen Messsondentyp, um die Sonde zuzuordnen.
              </p>
              <div class="selection-card__chips" *ngIf="selectedProbeType">
                <span class="selection-chip" *ngIf="selectedProbeType.breite != null">
                  Breite: {{ selectedProbeType.breite | number: '1.0-1' }} mm
                </span>
                <span class="selection-chip" *ngIf="selectedProbeType.hoehe != null">
                  Höhe: {{ selectedProbeType.hoehe | number: '1.0-1' }} mm
                </span>
                <span class="selection-chip" *ngIf="selectedProbeType.windungszahl != null">
                  Windungen: {{ selectedProbeType.windungszahl }}
                </span>
                <span class="selection-chip" *ngIf="selectedProbeType.alpha != null">
                  α: {{ selectedProbeType.alpha | number: '1.0-2' }}°
                </span>
              </div>
              <p class="selection-card__note" *ngIf="selectedProbeType?.notiz?.trim()">
                {{ selectedProbeType?.notiz }}
              </p>
              <button type="button" class="selection-card__action" (click)="openProbeSelect()">
                <span>{{ selectedProbeType ? 'Messsondentyp ändern' : 'Messsondentyp wählen' }}</span>
                <span class="selection-card__action-icon" aria-hidden="true">→</span>
              </button>
            </div>
          </div>

          <section class="form-section">
            <div class="form-field">
              <label for="name" class="form-label">Name</label>
              <div class="input-shell" [class.invalid]="saveError && isFieldInvalid('name')">
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  placeholder="Bezeichnung der Messeinstellung"
                  [(ngModel)]="selectedMeasurementSetting!.name"
                  name="name"
                  [class.is-invalid]="saveError && isFieldInvalid('name')"
                />
              </div>
              <div class="invalid-feedback" *ngIf="saveError && isFieldInvalid('name')">
                Bitte geben Sie einen Namen ein.
              </div>
            </div>

            <div class="form-field">
              <label for="sonden-pro-schenkel" class="form-label">Sonden pro Schenkel</label>
              <div class="input-shell" [class.invalid]="saveError && isFieldInvalid('sondenProSchenkel')">
                <select
                  class="form-select"
                  id="sonden-pro-schenkel"
                  [(ngModel)]="selectedMeasurementSetting!.sondenProSchenkel"
                  (ngModelChange)="createEmptyProbePositions()"
                  name="sondenProSchenkel"
                  [class.is-invalid]="saveError && isFieldInvalid('sondenProSchenkel')"
                >
                  @for (amount of schenkelAnzahl(); track $index) {
                    <option [ngValue]="amount">{{ amount }}</option>
                  }
                </select>
              </div>
              <div class="invalid-feedback" *ngIf="saveError && isFieldInvalid('sondenProSchenkel')">
                Bitte wählen Sie die Anzahl der Sonden pro Schenkel.
              </div>
            </div>
          </section>

          <div class="form-actions">
            <button type="button" class="btn btn-primary btn-modern" [disabled]="!(hasChanges() || coilOrProbeChanged())" (click)="saveChanges()">
              Speichern
            </button>
            <button type="button" class="btn btn-outline-secondary btn-modern" (click)="backToListing()">
              Zurück
            </button>
            <button
              *ngIf="!measurementSettingsService.selectedElementIsNew"
              type="button"
              class="btn btn-outline-danger btn-modern"
              (click)="openDeleteModal()"
            >
              Löschen
            </button>
          </div>

          <!-- global alerts used instead of inline save messages -->
        </div>
      </ng-container>
    </div>
  </div>
</div>

<ng-template #loadError>
  <p class="text-danger text-center mt-3">Fehler: Messeinstellung konnte nicht geladen werden.</p>
</ng-template>

<div
  class="modal fade modern-modal"
  tabindex="-1"
  role="dialog"
  [ngClass]="{ show: showDeleteModal }"
  [ngStyle]="{ display: showDeleteModal ? 'block' : 'none' }"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon danger">
          <span aria-hidden="true">⚠</span>
        </div>
        <h5 class="modal-title">Messeinstellung löschen?</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="showDeleteModal = false"></button>
      </div>

      <div class="modal-body">
        <p>Diese Aktion kann nicht rückgängig gemacht werden. Möchten Sie die Messeinstellung endgültig löschen?</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-modern" (click)="showDeleteModal = false">
          Abbrechen
        </button>
        <button type="button" class="btn btn-danger btn-modern" (click)="deleteSetting()">
          Löschen
        </button>
      </div>
    </div>
  </div>
</div>
