<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-xl-10 col-lg-11">
      <ng-container *ngIf="selectedCoil; else noCoil">
        <div class="card shadow-sm modern-card">
          <div class="form-header">
            <div class="form-header__titles">
              <h3>{{ coilsService.selectedElementIsNew ? 'Neue Spule' : 'Spule bearbeiten' }}</h3>
           
            </div>
            <span class="form-tag" [ngClass]="coilsService.selectedElementIsNew ? 'tag-new' : 'tag-edit'">
              {{ coilsService.selectedElementIsNew ? 'Neu' : 'Bearbeiten' }}
            </span>
          </div>

          <div class="card-intro" *ngIf="!coilsService.selectedElementIsNew && coilsService.elements.length > 0">
            <label for="coilSelect" class="visually-hidden">Spule auswählen</label>
            <div class="select-shell select-shell--full">
              <!--<select
                class="form-select select-control"
                id="coilSelect"
                name="coilSelect"
                [(ngModel)]="selectedCoilId"
                (ngModelChange)="onCoilSelectionChange($event)"
              >
                <option *ngFor="let coil of coilsService.elements" [value]="coil.id">
                  Spule #{{ coil.id }}
                </option>
              </select>-->
            </div>
          </div>

          <div class="coildetail-grid">
            <section class="coildetail-panel">
              <div class="coiltype-summary" [class.is-empty]="!selectedCoiltype">
                <div class="coiltype-summary__meta">
                  <span class="coiltype-summary__eyebrow">Spulentyp</span>
                  <h4>{{ selectedCoiltype?.name || 'Noch kein Spulentyp ausgewählt' }}</h4>
                  <!--<p class="coiltype-summary__id" *ngIf="selectedCoiltype">ID {{ selectedCoiltype?.id }}</p>-->
                </div>

                <ng-container *ngIf="selectedCoiltype; else coiltypeHint">
                  <div class="coiltype-summary__metrics">
                    <div class="metric-pill metric-pill">
                      <span class="metric-pill__label text-center">ID</span>
                      <span class="metric-pill__value text-center mt-2">{{ selectedCoiltype.id }}</span>
                    </div>
                    <div class="metric-pill metric-pill">
                      <span class="metric-pill__label text-center">Schenkel</span>
                      <span class="metric-pill__value text-center mt-2">{{ selectedCoiltype.schenkel }}</span>
                    </div>
                    <div class="metric-pill">
                      <span class="metric-pill__label text-center">Bandbreite</span>
                      <span class="metric-pill__value text-center mt-2">{{ selectedCoiltype.bandbreite | number: '1.0-1' }} mm</span>
                    </div>
                    <div class="metric-pill">
                      <span class="metric-pill__label text-center">Schichthöhe</span>
                      <span class="metric-pill__value text-center mt-2">{{ selectedCoiltype.schichthoehe | number: '1.0-1' }} mm</span>
                    </div>
                    <div class="metric-pill">
                      <span class="metric-pill__label text-center">Durchmesser</span>
                      <span class="metric-pill__value text-center mt-2">{{ selectedCoiltype.durchmesser | number: '1.0-1' }} mm</span>
                    </div>
                    <div class="metric-pill">
                      <span class="metric-pill__label text-center">Toleranz</span>
                      <span class="metric-pill__value text-center mt-2">{{ selectedCoiltype.toleranzbereich | number: '1.0-1' }} kg</span>
                    </div>
                  </div>
                </ng-container>

                <ng-template #coiltypeHint>
                  <p class="coiltype-summary__hint">
                    Wählen Sie einen Spulentyp
                  </p>
                </ng-template>

                <div class="coiltype-summary__footer justify-content-center">
                  <button type="button" class="coiltype-link" (click)="openCoiltypeSelect()">
                    <span>{{ selectedCoiltype ? 'Spulentyp ändern' : 'Spulentyp wählen' }}</span>
                    <span aria-hidden="true" class="coiltype-link__icon">→</span>
                  </button>
                </div>
              </div>
            </section>

            <section class="form-section">
              <div class="form-field">
                <label for="auftragsNr" class="form-label">Auftrags-Nummer</label>
                <div class="input-shell" [class.invalid]="saveError && !selectedCoil.auftragsnummer">
                  <input
                    type="text"
                    class="form-control"
                    id="auftragsNr"
                    placeholder="Auftrags-Nummer"
                    [(ngModel)]="selectedCoil!.auftragsnummer"
                    name="auftragsnummer"
                  />
                </div>
                <div class="invalid-feedback" *ngIf="saveError && !selectedCoil?.auftragsnummer">
                  Bitte geben Sie eine Auftragsnummer ein.
                </div>
              </div>

              <div class="form-field">
                <label for="auftragsPosNr" class="form-label">Auftrags-Position</label>
                <div class="input-shell" [class.invalid]="saveError && isFieldInvalid('auftragsPosNr')">
                  <input
                    type="text"
                    class="form-control"
                    id="auftragsPosNr"
                    placeholder="Auftrags-Position"
                    [(ngModel)]="selectedCoil!.auftragsPosNr"
                    name="auftragsPosNr"
                    min="0"
                  />
                </div>
                <div class="invalid-feedback" *ngIf="saveError && isFieldInvalid('auftragsPosNr')">
                  Bitte geben Sie eine Auftrags-Position ein.
                </div>
              </div>

              <div class="form-field">
                <label for="bemessungsspannung" class="form-label">Bemessungsspannung (V)</label>
                <div class="input-shell" [class.invalid]="saveError && isFieldInvalid('bemessungsspannung')">
                  <input
                    type="number"
                    class="form-control"
                    id="bemessungsspannung"
                    placeholder="Bemessungsspannung in V"
                    [(ngModel)]="selectedCoil!.bemessungsspannung"
                    name="bemessungsspannung"
                    min="0"
                  />
                </div>
                <div class="invalid-feedback" *ngIf="saveError && isFieldInvalid('bemessungsspannung')">
                  Bitte geben Sie eine Bemessungsspannung ein.
                </div>
              </div>

              <div class="form-field">
                <label for="bemessungsfrequenz" class="form-label">Bemessungsfrequenz (Hz)</label>
                <div class="input-shell" [class.invalid]="saveError && isFieldInvalid('bemessungsfrequenz')">
                  <input
                    type="number"
                    class="form-control"
                    id="bemessungsfrequenz"
                    placeholder="Bemessungsfrequenz in Hz"
                    [(ngModel)]="selectedCoil!.bemessungsfrequenz"
                    name="bemessungsfrequenz"
                    min="0"
                  />
                </div>
                <div class="invalid-feedback" *ngIf="saveError && isFieldInvalid('bemessungsfrequenz')">
                  Bitte geben Sie eine Bemessungsfrequenz ein.
                </div>
              </div>

              <div class="form-field">
                <label for="einheit" class="form-label">Einheit</label>
                <div class="input-shell" [class.invalid]="saveError && isFieldInvalid('einheit')">
                  <input
                    type="text"
                    class="form-control"
                    id="einheit"
                    placeholder="Einheit"
                    [(ngModel)]="selectedCoil!.einheit"
                    name="einheit"
                  />
                </div>
                <div class="invalid-feedback" *ngIf="saveError && isFieldInvalid('einheit')">
                  Bitte geben Sie eine Einheit ein.
                </div>
              </div>
            </section>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-primary btn-modern"
              [disabled]="!canSave()"
              (click)="saveChanges()">
              Speichern
            </button>
            <button type="button" class="btn btn-outline-secondary btn-modern" (click)="backToListing()">
              Zurück
            </button>
            <button
              *ngIf="!coilsService.selectedElementIsNew"
              type="button"
              class="btn btn-outline-danger btn-modern"
              (click)="openDeleteModal()"
            >
              Löschen
            </button>
          </div>

          <!-- global alerts used instead of inline save messages -->
        </div>
      </ng-container>

      <ng-template #noCoil>
        <p class="text-danger text-center mt-5">Fehler: Spule konnte nicht geladen werden.</p>
      </ng-template>
    </div>
  </div>
</div>

<div
  class="modal fade modern-modal"
  tabindex="-1"
  role="dialog"
  [ngClass]="{ show: showDeleteModal }"
  [ngStyle]="{ display: showDeleteModal ? 'block' : 'none' }"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon danger">
          <span aria-hidden="true">⚠</span>
        </div>
        <h5 class="modal-title">Spule löschen?</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="showDeleteModal = false"></button>
      </div>

      <div class="modal-body">
        <p>Diese Aktion kann nicht rückgängig gemacht werden. Möchten Sie die Spule endgültig löschen?</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-modern" (click)="showDeleteModal = false">
          Abbrechen
        </button>
        <button type="button" class="btn btn-danger btn-modern" (click)="deleteCoil()">
          Löschen
        </button>
      </div>
    </div>
  </div>
</div>
