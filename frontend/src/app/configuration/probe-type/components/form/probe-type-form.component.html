@if (selectedProbeType) {
  <div class="card shadow-sm modern-card">
    <div class="form-header">
      <div class="form-header__titles">
        <h3>{{ selectedProbeType.name?.trim() || 'Messsondentyp konfigurieren' }}</h3>
      </div>
      <span class="form-tag" [ngClass]="isNew ? 'tag-new' : 'tag-edit'">
        {{ isNew ? 'Neu' : 'Bearbeiten' }}
      </span>
    </div>

    <form #probeTypeForm="ngForm" (ngSubmit)="onSubmit(probeTypeForm)" class="modern-form">
      <div class="form-layout">
        <div class="form-column form-column--main">
          <div class="form-field">
            <label for="name" class="form-label">Messsondentyp-Name</label>
            <div class="input-shell" [class.invalid]="(saveError || nameElement.touched) && isFieldInvalid('name')">
              <input
                type="text"
                class="form-control"
                id="name"
                name="name"
                minlength="2"
                required
                placeholder="Name eingeben"
                [(ngModel)]="selectedProbeType!.name"
                #nameElement="ngModel"
                [class.is-invalid]="(saveError || nameElement.touched) && isFieldInvalid('name')"
                [readonly]="readOnly"
              />
            </div>
            @if ((saveError || nameElement.touched) && isFieldInvalid('name')) {
              <div class="invalid-feedback">
                Bitte geben Sie einen gültigen Namen ein.
              </div>
            }
          </div>
        </div>

        <div class="form-column form-column--metrics">
          <div class="metric-grid">
            <div class="form-field metric-field">
              <label for="hoehe" class="form-label">Höhe (mm)</label>
              <div class="input-shell" [class.invalid]="(saveError || hoeheElement.touched) && isFieldInvalid('hoehe')">
                <input
                  type="number"
                  class="form-control"
                  id="hoehe"
                  name="hoehe"
                  min="0.01"
                  step="0.01"
                  required
                  placeholder="Höhe in mm"
                  [(ngModel)]="selectedProbeType!.hoehe"
                  #hoeheElement="ngModel"
                  [class.is-invalid]="(saveError || hoeheElement.touched) && isFieldInvalid('hoehe')"
                  [readonly]="readOnly"
                />
              </div>
              @if ((saveError || hoeheElement.touched) && isFieldInvalid('hoehe')) {
                <div class="invalid-feedback">
                  Bitte geben Sie eine gültige Höhe ein.
                </div>
              }
            </div>

            <div class="form-field metric-field">
              <label for="breite" class="form-label">Breite (mm)</label>
              <div class="input-shell" [class.invalid]="(saveError || breiteElement.touched) && isFieldInvalid('breite')">
                <input
                  type="number"
                  class="form-control"
                  id="breite"
                  name="breite"
                  min="0.01"
                  step="0.01"
                  required
                  placeholder="Breite in mm"
                  [(ngModel)]="selectedProbeType!.breite"
                  #breiteElement="ngModel"
                  [class.is-invalid]="(saveError || breiteElement.touched) && isFieldInvalid('breite')"
                  [readonly]="readOnly"
                />
              </div>
              @if ((saveError || breiteElement.touched) && isFieldInvalid('breite')) {
                <div class="invalid-feedback">
                  Bitte geben Sie eine gültige Breite ein.
                </div>
              }
            </div>

            <div class="form-field metric-field">
              <label for="windungszahl" class="form-label">Windungszahl</label>
              <div
                class="input-shell"
                [class.invalid]="(saveError || windungszahlElement.touched) && isFieldInvalid('windungszahl')"
              >
                <input
                  type="number"
                  class="form-control"
                  id="windungszahl"
                  name="windungszahl"
                  min="1"
                  step="1"
                  required
                  placeholder="Windungszahl"
                  [(ngModel)]="selectedProbeType!.windungszahl"
                  #windungszahlElement="ngModel"
                  [class.is-invalid]="(saveError || windungszahlElement.touched) && isFieldInvalid('windungszahl')"
                  [readonly]="readOnly"
                />
              </div>
              @if ((saveError || windungszahlElement.touched) && isFieldInvalid('windungszahl')) {
                <div class="invalid-feedback">
                  Bitte geben Sie eine gültige Windungszahl ein.
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="form-field form-field--wide note-field">
        <label for="notiz" class="form-label">Notiz</label>
        <div class="input-shell">
          <textarea
            id="notiz"
            class="form-control"
            name="notiz"
            rows="3"
            placeholder="Notiz hinzufügen..."
            [(ngModel)]="selectedProbeType!.notiz"
            [readonly]="readOnly"
          ></textarea>
        </div>
      </div>

      <div class="form-actions">
        @if (!readOnly) {
          <button type="submit" class="btn btn-primary btn-modern" [disabled]="probeTypeForm.invalid || !hasChanges()">
            Speichern
          </button>
        } @else {
          <button type="button" class="btn btn-secondary btn-modern" [disabled]="true" title="Im Monteur-Modus nicht verfügbar">
            Speichern
          </button>
        }
        <button type="button" class="btn btn-outline-secondary btn-modern" (click)="backToListing()">
          Zurück
        </button>
        @if (!isNew) {
          @if (!readOnly) {
            <button
              type="button"
              class="btn btn-outline-danger btn-modern"
              (click)="openDeleteModal()"
            >
              Löschen
            </button>
          } @else {
            <button
              type="button"
              class="btn btn-outline-secondary btn-modern"
              [disabled]="true"
              title="Im Monteur-Modus nicht verfügbar"
            >
              Löschen
            </button>
          }
        }
      </div>

      @if (saveMessage) {
        <div class="text-center mt-3 text-success fw-bold">
          {{ saveMessage }}
        </div>
      }
    </form>
  </div>
} @else {
  <p class="text-danger text-center mt-3">Bitte wählen Sie einen Messsondentyp aus.</p>
}

<div
  class="modal fade modern-modal"
  tabindex="-1"
  role="dialog"
  [ngClass]="{ show: showDeleteModal }"
  [ngStyle]="{ display: showDeleteModal ? 'block' : 'none' }"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon danger">
          <span aria-hidden="true">⚠</span>
        </div>
        <h5 class="modal-title">Messsondentyp löschen?</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="showDeleteModal = false"></button>
      </div>

      <div class="modal-body">
        <p>Diese Aktion kann nicht rückgängig gemacht werden. Möchten Sie den Messsondentyp endgültig löschen?</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-modern" (click)="showDeleteModal = false">
          Abbrechen
        </button>
        <button type="button" class="btn btn-danger btn-modern" (click)="confirmDeleteProbeType()">
          Löschen
        </button>
      </div>
    </div>
  </div>
</div>
