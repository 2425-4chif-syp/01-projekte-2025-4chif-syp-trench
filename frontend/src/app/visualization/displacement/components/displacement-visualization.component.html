<!-- Visualization -->
<div id="visualization-container"
  [style.height.px]="size" [style.width.px]="size">
  <svg
    width="1024"
    height="1024"
    viewBox="0 0 24 24"
    fill="none"
    [attr.transform]="'rotate('+rotationOffset+')'"
  >
    <g [attr.transform]="'translate('+internalTranslationOffset+', '+internalTranslationOffset+') scale('+size/512+')'">
      <g [attr.transform]="">
        <g (mouseenter)="onBorderMouseEnter()" (mouseleave)="onBorderMouseLeave()">
          <!-- Border circle -->
          <circle cx="12" cy="12" r="6" 
          fill="none" 
          stroke="#000000" 
          [attr.stroke-width]="isHoveringOverBorder ? '0.125' : '0.0625'"
          [attr.stroke-opacity]="isHoveringOverBorder ? '1' : '0.5'"
          stroke-dasharray="0.0625,0.0625" 
          />

          <!-- Border circle hitbox -->
          <circle cx="12" cy="12" r="6"
          stroke="transparent"
          stroke-width="0.25"
          />
        </g>

        <!-- Vectors -->
        @for (branch of calcResults; track branch; let branchIndex = $index) {
          @for (vector of branch; track vector; let vectorIndex = $index) {
            <g 
              transform="translate(12, 12)"
              (mouseenter)="onArrowMouseEnter(branchIndex, vectorIndex)" (mouseleave)="onArrowMouseLeave()"
            >
              <!-- Arrow body -->
              <line
                x1="0"
                y1="0"
                [attr.x2]="scaledBranchResultX(vector, IsHoveringOverArrow(branchIndex, vectorIndex) ? -0.25 : -0.125)"
                [attr.y2]="scaledBranchResultY(vector, IsHoveringOverArrow(branchIndex, vectorIndex) ? -0.25 : -0.125)"
                [attr.stroke]="getArrowColor(branchIndex)"
                [attr.stroke-width]="IsHoveringOverArrow(branchIndex, vectorIndex) ? '0.25' : '0.125'"
                [attr.stroke-opacity]="IsHoveringOverArrow(branchIndex, vectorIndex) ? '1' : '0.75'"
              /> <!-- [attr.stroke-dasharray]="hoveredArrow === $index ? '0' : '0.0625,0.0625'" --> 

              <!-- Arrow triangle -->
              <polygon
                points="0.25,0 0,-0.125 0,0.125"
                [attr.fill]="getArrowColor(branchIndex)"
                [attr.transform]="'translate('
                  +scaledBranchResultX(vector, IsHoveringOverArrow(branchIndex, vectorIndex) ? -0.25 : -0.125)+', '
                  +scaledBranchResultY(vector, IsHoveringOverArrow(branchIndex, vectorIndex) ? -0.25 : -0.125)
                  +') rotate('+(vector.angle * radToDeg)+') scale('+(IsHoveringOverArrow(branchIndex, vectorIndex) ? '1.5' : '1')+')'"
                [attr.fill-opacity]="IsHoveringOverArrow(branchIndex, vectorIndex) ? '1' : '0.75'"
                />

              <!-- Arrow hitbox -->
              <line
                x1="0"
                y1="0"
                [attr.x2]="scaledBranchResultX(vector, 0)"
                [attr.y2]="scaledBranchResultY(vector, 0)"
                stroke="transparent"
                stroke-width="0.25"
              /> 
            </g>
          }
        }
        <!-- Result vector -->
        <g 
        transform="translate(12, 12)"
        (mouseenter)="onResultArrowMouseEnter()" (mouseleave)="onArrowMouseLeave()"
        >
        @if (finalVector.length / averageLength > 0.01) {
          <!-- Arrow body -->
          @if (finalVector.length / averageLength >= 0.03) {
            <line
              x1="0"
              y1="0"
              [attr.x2]="scaledBranchResultX(finalVector, IsHoveringOverResultArrow() ? -0.25 : -0.125)"
              [attr.y2]="scaledBranchResultY(finalVector, IsHoveringOverResultArrow() ? -0.25 : -0.125)"
              [attr.stroke-width]="IsHoveringOverResultArrow() ? '0.25' : '0.125'"
              stroke="black"
            />
          }

          <!-- Arrow triangle -->
          <polygon
            [attr.points]="(finalVector.length / averageLength >= 0.05 || IsHoveringOverResultArrow()) ? '0.25,0 0,-0.125 0,0.125' : '0.25,0 0,-0.0625 0,0.0625'"
            fill="black"
            [attr.transform]="'translate('
            +scaledBranchResultX(finalVector, IsHoveringOverResultArrow() && finalVector.length / averageLength >= 0.05 ? -0.25 : -0.125)+', '
            +scaledBranchResultY(finalVector, IsHoveringOverResultArrow() && finalVector.length / averageLength >= 0.05 ? -0.25 : -0.125)
            +') rotate('+(finalVector.angle * radToDeg)
            +') scale('+(IsHoveringOverResultArrow() && finalVector.length / averageLength >= 0.05 ? '1.5' : '1')+')'"
            />
          }
        
          <!-- Center circle -->
          <circle cx="0" cy="0" [attr.r]="IsHoveringOverResultArrow() ? '0.125' : '0.0625'" fill="black" />
        </g>
      </g>
    </g>
  </svg>

  <app-coil-visualization
    [n]="yokes().length"
    [size]="size"
  ></app-coil-visualization>
</div>

@if (mousePosition !== null && (hoveredArrow !== null || isHoveringOverBorder)) {
  <div class="hover-tooltip" [ngStyle]="{
      'top.px': mousePosition.y,
      'left.px': mousePosition.x,
  }">
    @if (hoveredArrow !== null) {
      <ul>
        <li>
          <strong>Branch</strong>: {{ (IsHoveringOverResultArrow() ? 'Final Vector' : 'Branch ' + (hoveredArrow.branchIndex + 1)) }}
        </li>
        <li>
          <strong>x</strong>: {{ (IsHoveringOverResultArrow() ? finalVector.x : calcResults[hoveredArrow.branchIndex][hoveredArrow.sensorIndex].x) | number: '1.2-2' }}
        </li>
        <li>
          <strong>y</strong>: {{ (IsHoveringOverResultArrow() ? finalVector.y : calcResults[hoveredArrow.branchIndex][hoveredArrow.sensorIndex].y) | number: '1.2-2' }}
        </li>
        <li>
          <strong>Length</strong>: {{ (IsHoveringOverResultArrow() ? finalVector.length : calcResults[hoveredArrow.branchIndex][hoveredArrow.sensorIndex].length ) | number: '1.2-2' }}
        </li>
        <li>
          <strong>Difference from average</strong>: {{ ((IsHoveringOverResultArrow() ? finalVector.length : calcResults[hoveredArrow.branchIndex][hoveredArrow.sensorIndex].length) - averageLength) | number: '1.2-2' }}
        </li>
        <li>
          <strong>Angle</strong>: {{ (IsHoveringOverResultArrow() ? finalVector.angle : calcResults[hoveredArrow.branchIndex][hoveredArrow.sensorIndex].angle)*radToDeg | number: '1.2-2' }}Â°
        </li>
      </ul>
    }
    @if (isHoveringOverBorder) {
      <p><strong>Border radius</strong> (average length): {{averageLength | number: '1.2-2'}}</p>
    }
  </div>  
}